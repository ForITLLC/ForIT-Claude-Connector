name: Deploy Connector to Power Platform

on:
  workflow_dispatch:
    inputs:
      connector:
        description: 'Connector to deploy'
        required: true
        default: 'claude'
        type: choice
        options:
          - claude
          - gemini
          - forit-ai
      environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production
          - forit-default
          - forit-portal
          - pivot
          - all
      action:
        description: 'Deployment action'
        required: true
        default: 'update'
        type: choice
        options:
          - create
          - update
      licensed:
        description: 'Include ForIT license validation'
        required: false
        default: false
        type: boolean

  push:
    branches: [main, master]
    paths:
      - 'connectors/**'

jobs:
  detect-changes:
    name: Detect Changed Connectors
    runs-on: ubuntu-latest
    outputs:
      claude_changed: ${{ steps.changes.outputs.claude }}
      gemini_changed: ${{ steps.changes.outputs.gemini }}
      forit_ai_changed: ${{ steps.changes.outputs.forit_ai }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes
        id: changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q '^connectors/claude/'; then
            echo "claude=true" >> $GITHUB_OUTPUT
          else
            echo "claude=false" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only HEAD~1 HEAD | grep -q '^connectors/gemini/'; then
            echo "gemini=true" >> $GITHUB_OUTPUT
          else
            echo "gemini=false" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only HEAD~1 HEAD | grep -q '^connectors/forit-ai/'; then
            echo "forit_ai=true" >> $GITHUB_OUTPUT
          else
            echo "forit_ai=false" >> $GITHUB_OUTPUT
          fi

  validate:
    name: Validate Connector
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate Claude
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.connector == 'claude' || github.event_name == 'push' && needs.detect-changes.outputs.claude_changed == 'true'
        working-directory: connectors/claude
        run: |
          npm ci
          npm test

      - name: Validate Gemini
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.connector == 'gemini' || github.event_name == 'push' && needs.detect-changes.outputs.gemini_changed == 'true'
        working-directory: connectors/gemini
        run: |
          if [ -f "package.json" ]; then
            npm ci
            npm test
          fi

      - name: Validate ForIT AI
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.connector == 'forit-ai' || github.event_name == 'push' && needs.detect-changes.outputs.forit_ai_changed == 'true'
        working-directory: connectors/forit-ai
        run: |
          if [ -f "package.json" ]; then
            npm ci
            npm test
          fi

  deploy:
    name: Deploy to ${{ matrix.environment }}
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        environment: ${{ github.event.inputs.environment == 'all' && fromJson('["development", "production", "forit-default", "forit-portal", "pivot"]') || fromJson(format('["{0}"]', github.event.inputs.environment)) }}
    environment:
      name: ${{ matrix.environment }}
      url: ${{ vars.POWER_PLATFORM_URL }}

    steps:
      - uses: actions/checkout@v4

      - name: Set connector paths
        id: paths
        run: |
          CONNECTOR="${{ github.event.inputs.connector }}"
          LICENSED="${{ github.event.inputs.licensed }}"
          echo "dir=connectors/${CONNECTOR}" >> $GITHUB_OUTPUT
          echo "definition=connectors/${CONNECTOR}/${CONNECTOR}-connector.json" >> $GITHUB_OUTPUT
          if [ "$LICENSED" == "true" ]; then
            echo "properties=connectors/${CONNECTOR}/apiProperties.licensed.json" >> $GITHUB_OUTPUT
          else
            echo "properties=connectors/${CONNECTOR}/apiProperties.json" >> $GITHUB_OUTPUT
          fi
          echo "script=connectors/${CONNECTOR}/script.csx" >> $GITHUB_OUTPUT
          echo "licensed=${LICENSED}" >> $GITHUB_OUTPUT

      - name: Install Power Platform CLI
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Authenticate
        run: |
          $POWERPLATFORMTOOLS_PACPATH auth create \
            --name deploy \
            --applicationId ${{ secrets.POWER_PLATFORM_APP_ID }} \
            --clientSecret "${{ secrets.POWER_PLATFORM_CLIENT_SECRET }}" \
            --tenant ${{ secrets.POWER_PLATFORM_TENANT_ID }} \
            --accept-cleartext-caching

      - name: Get Connector ID
        id: connector-id
        run: |
          CONNECTOR="${{ github.event.inputs.connector }}"
          if [ "$CONNECTOR" == "gemini" ]; then
            echo "id=${{ vars.GEMINI_CONNECTOR_ID }}" >> $GITHUB_OUTPUT
          elif [ "$CONNECTOR" == "forit-ai" ]; then
            echo "id=${{ vars.FORIT_AI_CONNECTOR_ID }}" >> $GITHUB_OUTPUT
          else
            echo "id=${{ vars.CONNECTOR_ID }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy Connector
        run: |
          if [ "${{ github.event.inputs.action }}" == "create" ]; then
            $POWERPLATFORMTOOLS_PACPATH connector create \
              --api-definition-file ${{ steps.paths.outputs.definition }} \
              --api-properties-file ${{ steps.paths.outputs.properties }} \
              --script-file ${{ steps.paths.outputs.script }} \
              --environment ${{ vars.POWER_PLATFORM_URL }}
          else
            $POWERPLATFORMTOOLS_PACPATH connector update \
              --connector-id ${{ steps.connector-id.outputs.id }} \
              --api-definition-file ${{ steps.paths.outputs.definition }} \
              --api-properties-file ${{ steps.paths.outputs.properties }} \
              --script-file ${{ steps.paths.outputs.script }} \
              --environment ${{ vars.POWER_PLATFORM_URL }}
          fi

      - name: Summary
        run: |
          echo "## ${{ matrix.environment }} Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Connector | ${{ github.event.inputs.connector }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | $(jq -r '.info.version' ${{ steps.paths.outputs.definition }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Licensed | ${{ steps.paths.outputs.licensed }} |" >> $GITHUB_STEP_SUMMARY
